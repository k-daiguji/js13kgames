<head>
  <meta charset="UTF-8">
  <title>Apex Predator</title>
  <style type="text/css"> progress { width: 280px } </style>
  <script src="dist/Character.js"></script>
  <script src="dist/MainCharacter.js"></script>
  <script src="dist/Enemy.js"></script>
  <script src="dist/GameMap.js"></script>
</head>
<body>
  <div>
    HP
    <progress id="life_bar" value="100" max="100" min="-1"></progress>
  </div>
  <canvas id="game_map" width="500" height="500" autofocus></canvas>
  <script>
    var cv = document.getElementById('game_map');
    var ctx = cv.getContext("2d");
    var map = new GameMap(0, 0, 30, 30, '#84C98B');
    var mainCharacter = new MainCharacter(10, 80, "./dist/resources/plant.png", map, 1, 1);
    var zebra = new Enemy(10, 60, "./dist/resources/zebra.png", mainCharacter, map, 1, 9);
    var zebra2 = new Enemy(10, 60, "./dist/resources/zebra.png", mainCharacter, map, 5, 8);
    var tiger = new Enemy(10, 90, "./dist/resources/taiga.png", zebra, map, 10, 7);
    var tiger2 = new Enemy(10, 90, "./dist/resources/taiga.png", zebra2, map, 10, 10);
    var person = new Enemy(10, 50, "./dist/resources/person_male.png", tiger, map, 4, 7);
    var person2 = new Enemy(10, 50, "./dist/resources/person_female.png", tiger2, map, 4, 12);
    mainCharacter.setTarget([person, person2]);
    var enemies = [
      zebra,
      zebra2,
      tiger,
      tiger2,
      person,
      person2,
    ];

    var life = document.getElementById('life_bar');

    cv.tabIndex = 1;
    cv.onkeydown = function(event) {
      event.preventDefault();
      switch(event.keyCode) {
        case 37: // ←
            mainCharacter.goMove(3)
            break;
        case 38: // ↑
            mainCharacter.goMove(1)
            break;
        case 39: // →
            mainCharacter.goMove(4)
            break;
        case 40: // ↓
            mainCharacter.goMove(2)
            break;
      }
    };

    function playLoop(duration) {
      ctx.beginPath();
      ctx.fillStyle = '#FFFFFF';
      ctx.strokeStyle = '#FFFFFF';
      ctx.rect(0, 0, cv.width, cv.height);
      ctx.fill();
      ctx.stroke();

      map.draw(ctx);

      mainCharacter.move(duration);
      mainCharacter.draw(ctx);
      enemies.forEach(enemy => {
        enemy.move1(duration);
        enemy.killTarget();
        enemy.draw(ctx);
      });
    }

    var previousDrawingTime = 0;
    var count = 0;
    function mainLoop(timestamp) {
      if(previousDrawingTime === 0) {
        previousDrawingTime = timestamp;
      }
      var aliveEnemies = []
      enemies.forEach((enemy) => {
        if (enemy.isAlive()){
          aliveEnemies.push(enemy)
        }
      })
      enemies = aliveEnemies;

      if (mainCharacter.isAlive() && life.value > 0) {
          mainCharacter.killTarget();
          var duration = timestamp - previousDrawingTime;
          if (count++ > 10) {
            count = 0;
            life.value--;
          }
          playLoop(duration);
          previousDrawingTime = timestamp;
          window.requestAnimationFrame(mainLoop);
      } else {
        if (!alert("Game Over!")) {
          window.location.reload();
        }
      }
    }
    window.requestAnimationFrame(mainLoop);
  </script>
</body>
