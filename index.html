<head>
  <meta charset="UTF-8">
  <title></title>
  <script src="dist/src/Character.js"></script> <!-- Character のコンストラクタが定義されているファイルを読み込み。 -->
  <script src="dist/src/MainCharacter.js"></script> <!-- Pacman のコンストラクタが定義されているファイルを読み込み。 -->
  <script src="dist/src/Enemy.js"></script> <!-- Akabei のコンストラクタが定義されているファイルを読み込み。 -->
  <script src="dist/src/GameMap.js"></script> <!-- map001 のコンストラクタが定義されているファイルを読み込み。 -->
</head>
<body>
<canvas id="pac-man" width="640" height="640"></canvas> <!-- キャンバスを作成。ここにゲームが描画される。 -->
<script>
  // キャンバスとそのキャンバスのコンテクストを取得。
  var cv = document.getElementById('pac-man');
  var ctx = cv.getContext("2d");

  // マップのインスタンスを作成。
  var map = new GameMap(0, 0, 20, 20, '#84C98B');

  // パックマンのインスタンスを作成。
  var pacman = new MainCharacter(10, 80, 30, map, 1, 1);

  // あかべいのインスタンスを作成。
  var enemies = [
    new Enemy(10, 80, '#FF0000', pacman, map, 1, 9),
    new Enemy(10, 60, '#00FF00', pacman, map, 9, 6),
    new Enemy(10, 90, '#0000FF', pacman, map, 10, 7),
  ];
  // キャンバスをフォーカスできるように設定。
  cv.tabIndex = 1;

  // キャンバスに対して、キーが押された時の処理方法を設定。
  cv.onkeydown = function(event) {
      event.preventDefault(); // ブラウザによって設定されているデフォルトの動作を無効化。

      // JavaScript では、キーボードのキーそれぞれに整数値が割り当てられており、
      // 押されたキーの番号が event オブジェクトの keyCode 属性にセットされる。
      switch(event.keyCode) {
          case 37: // キーボードの左ボタンが押された。
              pacman.goMove(3)
              break;
          case 38: // キーボードの上ボタンが押された。
              pacman.goMove(1)
              break;
          case 39: // キーボードの右ボタンが押された。
              pacman.goMove(4)
              break;
          case 40: // キーボードの下ボタンが押された。
              pacman.goMove(2)
              break;
      }
  };

  function playLoop(duration) {
      ctx.beginPath();
      ctx.fillStyle = '#FFFFFF';
      ctx.strokeStyle = '#FFFFFF';
      ctx.rect(0, 0, cv.width, cv.height); // 一つ前のフレームに描画された画面を消去。
      ctx.fill();
      ctx.stroke();

      map.draw(ctx); // マップを描画。

      pacman.move(duration); // パックマンを移動させる。
      pacman.draw(ctx); // パックマンを描画。

      for (var i = 0; i < enemies.length; i++) {
          enemies[i].move1(duration);
          enemies[i].killTarget();
          enemies[i].draw(ctx);
      }
  }

  // ゲーム画面を描画して進行させる関数。
  // window.requestAnimationFrame メソッドから呼び出される。
  var previousDrawingTime = 0;
  function mainLoop(timestamp) {
      if(previousDrawingTime == 0) {
          previousDrawingTime = timestamp;
      }

      var duration = timestamp - previousDrawingTime; // 前回の描画からの経過時間 (ms)

      if (pacman.isAlive()) {
          playLoop(duration);
      }

      previousDrawingTime = timestamp; // 描画した時刻の更新。
      window.requestAnimationFrame(mainLoop); // 次のフレームの描画をブラウザに依頼。
  }

  // ブラウザに mainLoop 関数を用いてゲーム画面の描画をするように依頼。
  // 描画のタイミングはブラウザが決定する。
  window.requestAnimationFrame(mainLoop);
</script>

</body>
</html>
